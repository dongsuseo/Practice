# useState를 조건문 안에서 사용하면 안 될까?

### 결론부터 말하면 안된다

## Why?

> useState를 조건문 안에서 호출하면, 이전 렌더와 훅 호출 순서/개수가 달라져  
> React가 슬롯 매핑을 잘못 재사용하게 되고, 그래서 상태와 업데이트 큐가 엉켜버린다.

## 예시

```javascript
function Example({ condition }) {
    if (condition) {
        const [a, setA] = useState(0); // (A) 조건부 훅
    }
    const [b, setB] = useState(0); // (B) 항상 호출되는 훅
}
```

### 렌더 #1: `condition === true`

호출 순서:

1. (A) `useState(0)` → **슬롯#0** 생성/사용 → `a`는 슬롯#0
2. (B) `useState(0)` → **슬롯#1** 생성/사용 → `b`는 슬롯#1

> 이 시점의 슬롯 매핑
>
> -   슬롯#0 ↔ `a`
> -   슬롯#1 ↔ `b`

### 렌더 #2: `condition === false`

호출 순서가 바뀜:

1. (A) 스킵됨 (조건이 false라서 `useState` 자체가 호출 안 됨)
2. (B) `useState(0)` → **React는 “첫 번째 호출된 훅”이므로 슬롯#0을 가져옴**

여기서 사고 발생:

-   이번 렌더에서 **첫 번째로 호출된 훅(B)** 이 **이전 렌더의 슬롯#0**(원래 `a`의 자리)을 가져간다.
-   즉, `b`가 **`a`의 상태를 가져**오고, `setB`도 원래 `a`가 쓰던 업데이트 큐에 연결된다.

> 이 시점의 잘못된 슬롯 매핑
>
> -   슬롯#0 ↔ (이번 렌더의) `b` **(원래는 `a` 자리였음)**
> -   슬롯#1 ↔ (이번 렌더에서는 호출조차 안 됨)

그 결과:

-   `b`가 갑자기 `a`의 값으로 바뀐 것처럼 보이거나,
-   이후 렌더에서 훅 호출 개수가 다시 달라지면 **개수가 맞지 않는 훅 호출**로 이어져 개발 모드에서
    “**Rendered fewer hooks than expected**” 같은 오류가 터진다.
-   더 위험한 건 오류가 안 터져도 **`setB`가 `a`의 큐에 쌓이는 등 잘못된 상태 라우팅**이 일어나서 디버깅 지옥을 맛보게 된다는 것.

---

## 왜 “호출 순서 불변”이 필수인가?

React는 “n번째로 호출된 훅”은 “n번째 슬롯”이라는 전제를 두고 상태를 연결해 둔다.
조건문/반복문/조기 return 등으로 훅 호출의 **개수나 순서가 바뀌면**:

-   어떤 변수에 어떤 슬롯(=이전 렌더의 state)이 연결되어야 하는지 매칭에 실패
-   어떤 `setState`가 어떤 상태에 적용돼야 하는지도 꼬임
-   개발 모드에선 위반을 감지해 에러를 던지지만, 프로덕션에선 **묵시적 오동작**으로 이어질 수 있음

이건 `useEffect`, `useMemo`, `useRef` 등 **모든 훅이 동일**하다.  
(전부 같은 훅 슬롯 체인/커서 메커니즘을 공유함)
